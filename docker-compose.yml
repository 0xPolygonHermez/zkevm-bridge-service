version: '3'
services:
  hez-postgres-core:
    container_name: hez-postgres-core
    image: postgres
    ports:
      - 5432:5432
    environment:
      # In order to update this values, you may need to run: docker rm -f -v postgres
      - POSTGRES_USER=test_user
      - POSTGRES_PASSWORD=test_password
      - POSTGRES_DB=test_db

  hez-postgres-bridge:
    container_name: hez-postgres-bridge
    image: postgres
    expose:
      - 5433
    ports:
      - 5433:5433
    environment:
      # In order to update this values, you may need to run: docker rm -f -v postgres
      - POSTGRES_USER=test_user
      - POSTGRES_PASSWORD=test_password
      - POSTGRES_DB=test_db
    command: -p 5433 -N 500

  hez-core:
    container_name: hez-core
    image: hermeznetwork/hermez-node-zkevm:develop@sha256:907e5db91c21d873cbcce0db1e325e5b7b9672f48b70b8ffa90f783ddd80bf77
    ports:
      - 8123:8123
    environment:
      - HERMEZCORE_DATABASE_USER=test_user
      - HERMEZCORE_DATABASE_PASSWORD=test_password
      - HERMEZCORE_DATABASE_NAME=test_db
      - HERMEZCORE_DATABASE_HOST=hez-postgres-core
      - HERMEZCORE_DATABASE_PORT=5432
      - HERMEZCORE_ETHERMAN_PRIVATEKEYPATH=/pk/keystore
    volumes:
      - ./test/test.keystore:/pk/keystore
    #command: ["./hezcore", "run", "--network", "local", "--cfg", "/app/config.local.toml"]
    command: >
      sh -c "./hezcore register --cfg /app/config.local.toml --network local -y http://hez-core:8123 &&
             ./hezcore approve --cfg /app/config.local.toml --network local --amount 10000 -y &&
             ./hezcore run --network local --cfg /app/config.local.toml"

  hez-network:
    container_name: hez-network
    image: hermeznetwork/geth-zkevm-contracts@sha256:07dfeef4c64d7913bceee62dbdc58c0c7ac5996283542dfb3c64774dade96ce5
    ports:
      - 8545:8545

  hez-prover:
    container_name: hez-prover
    image: hermeznetwork/hez-mock-prover@sha256:3a86d0c65f0428decb7f1f3843b753bf6846bf43f6c628ab0b4d298fe7f918f2
    ports:
      - 50051:50051
    environment:
      - POSTGRES_USER=test_user
      - POSTGRES_PASSWORD=test_password
      - POSTGRES_DB=test_db
      - POSTGRES_HOST=hez-postgres-core
      - POSTGRES_PORT=5432
      - PROOF_TIME=1000

  hez-bridge:
    container_name: hez-bridge
    image: hermeznetwork/hermez-bridge
    ports:
      - 8080:8080
      - 9090:9090
    environment:
      - HERMEZBRIDGE_DATABASE_USER=test_user
      - HERMEZBRIDGE_DATABASE_PASSWORD=test_password
      - HERMEZBRIDGE_DATABASE_NAME=test_db
      - HERMEZBRIDGE_DATABASE_HOST=hez-postgres-bridge
      - HERMEZBRIDGE_DATABASE_PORT=5433
      - HERMEZBRIDGE_ETHERMAN_PRIVATEKEYPATH=/pk/keystore
    volumes:
      - ./test/test.keystore:/pk/keystore
      - ./config/config.local.toml:/app/config.toml
    command: ["./hezbridge", "run", "--network", "local", "--cfg", "/app/config.toml"]

  hez-bridge-mock:
    container_name: hez-bridge-mock
    image: hermeznetwork/hermez-bridge
    ports:
      - 8080:8080
      - 9090:9090
    environment:
      - HERMEZBRIDGE_DATABASE_USER=test_user
      - HERMEZBRIDGE_DATABASE_PASSWORD=test_password
      - HERMEZBRIDGE_DATABASE_NAME=test_db
      - HERMEZBRIDGE_DATABASE_HOST=hez-postgres-bridge
      - HERMEZBRIDGE_DATABASE_PORT=5433
    command: ["./hezbridge", "mockserver"]